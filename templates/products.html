{% extends "base.html" %}

{% block title %}Products{% endblock %}

{% block extra_css %}
<style>
    .product-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        padding: 1rem;
    }

    .product-card {
        background: var(--card-bg);
        border-radius: 8px;
        box-shadow: var(--shadow-sm);
        padding: 1rem;
        transition: var(--transition);
    }

    .product-card:hover {
        box-shadow: var(--shadow);
        transform: translateY(-2px);
    }

    .card-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
        padding: 0.25rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .card-row:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .card-row .label {
        font-size: 0.875rem;
        color: var(--text-color);
        opacity: 0.8;
        font-weight: 500;
        flex: 1;
    }

    .card-row .value {
        font-size: 0.875rem;
        color: var(--text-color);
        font-weight: 600;
        text-align: left;
        flex: 1;
    }

    .product-card .actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 0.5rem;
        border-top: 1px solid var(--border-color);
    }

    .product-card .stock-controls {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .product-card .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .table-responsive {
        display: none;
    }

    @media (max-width: 1400px) {
        .product-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 1200px) {
        .product-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .product-grid {
            grid-template-columns: 1fr;
        }
    }

    .badge {
        font-size: 0.75rem;
        font-weight: 500;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
    }

    .notes-text {
        white-space: pre-line;
        font-size: 0.8125rem;
        color: var(--text-color);
        opacity: 0.9;
    }

    .card-row .value {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        align-items: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="flex-grow-1">
            <h5 class="mb-0">Products List</h5>
            <div class="mt-2">
                <div class="input-group">
                    <input type="text" id="productSearch" class="form-control" placeholder="Search by item code, name, location, tags...">
                    <button class="btn btn-outline-secondary" type="button" id="searchHelp" data-bs-toggle="popover" data-bs-placement="bottom">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
                <small class="text-muted">Press Enter to search across all products</small>
            </div>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            {% if current_user.role == 'admin' or current_user.has_permission('edit_products') %}
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="fas fa-plus"></i> Add Product
            </button>
            {% endif %}
            
            {% if current_user.role == 'admin' or current_user.has_permission('import_products') %}
            <button type="button" class="btn btn-success" id="importButton">
                <i class="fas fa-file-import"></i> Import
            </button>
            <input type="file" id="importFile" style="display: none" accept=".xlsx,.xls" onchange="handleImport(this)">
            {% endif %}
            
            {% if current_user.role == 'admin' or current_user.has_permission('export_products') %}
            <a href="{{ url_for('export_products') }}" class="btn btn-info">
                <i class="fas fa-file-export"></i> Export
            </a>
            {% endif %}
        </div>
    </div>
    <div class="card-body">
        <form id="import-form" style="display: none;">
            <input type="file" id="import-excel" accept=".xlsx,.xls,.csv" onchange="handleImport(this)">
        </form>

        <div id="searchResults" style="display: none;">
            <h6 class="border-bottom pb-2">Search Results</h6>
            <div id="searchResultsGrid" class="product-grid">
            </div>
            <button class="btn btn-secondary mt-3" onclick="clearSearch()">Clear Search</button>
        </div>

        <div id="regularContent">
            <div class="product-grid">
                {% for product in products %}
                <div class="product-card" data-id="{{ product.id }}">
                    {% if current_user.role == 'admin' or current_user.has_permission('view_product_code') %}
                    <div class="card-row">
                        <span class="label">Item Code</span>
                        <span class="value">{{ product.item_code }}</span>
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('view_product_description') %}
                    <div class="card-row">
                        <span class="label">Description</span>
                        <span class="value">{{ product.description }}</span>
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('view_product_tamil') %}
                    {% if product.tamil_name %}
                    <div class="card-row">
                        <span class="label">Tamil Name</span>
                        <span class="value">{{ product.tamil_name }}</span>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('view_product_uom') %}
                    <div class="card-row">
                        <span class="label">UOM</span>
                        <span class="value">{{ product.uom }}</span>
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('view_product_price') %}
                    <div class="card-row">
                        <span class="label">Price</span>
                        <span class="value">â‚¹{{ product.price }}</span>
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('view_product_stock') %}
                    <div class="card-row">
                        <span class="label">Stock</span>
                        <span class="value">{{ product.stock }}</span>
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('view_product_restock') %}
                    <div class="card-row">
                        <span class="label">Restock Level</span>
                        <span class="value">{{ product.restock_level }}</span>
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('view_product_locations') %}
                    {% if product.stock_locations %}
                    <div class="card-row">
                        <span class="label">Locations</span>
                        <span class="value">
                            {% for location in product.stock_locations.split(',') %}
                            <span class="badge bg-info me-1">{{ location.strip() }}</span>
                            {% endfor %}
                        </span>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('view_product_tags') %}
                    {% if product.tags %}
                    <div class="card-row">
                        <span class="label">Tags</span>
                        <span class="value">
                            {% for tag in product.tags.split(',') %}
                            <span class="badge bg-secondary me-1">{{ tag.strip() }}</span>
                            {% endfor %}
                        </span>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('view_product_notes') %}
                    {% if product.notes %}
                    <div class="card-row">
                        <span class="label">Notes</span>
                        <span class="value notes-text">{{ product.notes }}</span>
                    </div>
                    {% endif %}
                    {% endif %}

                    {% if current_user.role == 'admin' or current_user.has_permission('view_product_suppliers') %}
                    {% if product.suppliers %}
                    <div class="card-row">
                        <span class="label">Supplied By</span>
                        <span class="value">
                            {% for supplier in product.suppliers %}
                            <span class="badge bg-primary me-1">{{ supplier.name }}</span>
                            {% endfor %}
                        </span>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('manage_stock') %}
                    <div class="stock-controls">
                        <button class="btn btn-outline-danger quick-stock-dec" data-id="{{ product.id }}">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button class="btn btn-outline-success quick-stock-inc" data-id="{{ product.id }}">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    {% endif %}
                    
                    <div class="actions">
                        {% if current_user.role == 'admin' or current_user.has_permission('edit_products') %}
                        <button class="btn btn-primary edit-product" 
                                data-id="{{ product.id }}"
                                data-item-code="{{ product.item_code }}"
                                data-description="{{ product.description }}"
                                data-tamil-name="{{ product.tamil_name or '' }}"
                                data-uom="{{ product.uom }}"
                                data-price="{{ product.price }}"
                                data-stock="{{ product.stock }}"
                                data-restock-level="{{ product.restock_level or 0 }}"
                                data-stock-locations="{{ product.stock_locations or '' }}"
                                data-tags="{{ product.tags or '' }}"
                                data-notes="{{ product.notes or '' }}"
                                onclick="return false;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        {% endif %}
                        
                        {% if current_user.role == 'admin' or current_user.has_permission('delete_products') %}
                        <button class="btn btn-danger delete-product" data-id="{{ product.id }}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-4">
            <div class="text-muted">
                Showing {{ products|length }} products
            </div>
            <nav aria-label="Product navigation">
                <ul class="pagination mb-0">
                    <!-- Previous page -->
                    <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('products', page=current_page-1) if current_page > 1 else '#' }}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    
                    <!-- First page -->
                    {% if current_page > 3 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('products', page=1) }}">1</a>
                    </li>
                    {% if current_page > 4 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    {% endif %}
                    
                    <!-- Page numbers -->
                    {% for page_num in range(
                        [1, current_page - 2]|max,
                        [total_pages, current_page + 2]|min + 1
                    ) %}
                    <li class="page-item {% if page_num == current_page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('products', page=page_num) }}">{{ page_num }}</a>
                    </li>
                    {% endfor %}
                    
                    <!-- Last page -->
                    {% if current_page < total_pages - 2 %}
                    {% if current_page < total_pages - 3 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('products', page=total_pages) }}">{{ total_pages }}</a>
                    </li>
                    {% endif %}
                    
                    <!-- Next page -->
                    <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('products', page=current_page+1) if current_page < total_pages else '#' }}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Keep the table for reference but hide it -->
        <div class="table-responsive" style="display: none;">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Item Code</th>
                        <th>Description</th>
                        <th>Tamil Name</th>
                        <th>UOM</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Restock Level</th>
                        <th>Quick Stock</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td>{{ product.item_code }}</td>
                        <td>{{ product.description }}</td>
                        <td>{{ product.tamil_name or '' }}</td>
                        <td>{{ product.uom }}</td>
                        <td>{{ product.price }}</td>
                        <td>{{ product.stock }}</td>
                        <td>{{ product.restock_level }}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-danger quick-stock-dec" data-id="{{ product.id }}">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success quick-stock-inc" data-id="{{ product.id }}">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary edit-product" 
                                    data-id="{{ product.id }}"
                                    data-code="{{ product.item_code }}"
                                    data-description="{{ product.description }}"
                                    data-tamil-name="{{ product.tamil_name or '' }}"
                                    data-uom="{{ product.uom }}"
                                    data-price="{{ product.price }}"
                                    data-stock="{{ product.stock }}"
                                    data-restock-level="{{ product.restock_level }}">
                                Edit
                            </button>
                            <button class="btn btn-sm btn-danger delete-product" data-id="{{ product.id }}">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_code') %}
                    <div class="mb-3">
                        <label class="form-label">Item Code</label>
                        <input type="text" class="form-control" name="item_code" required>
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_description') %}
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" name="description" required>
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_tamil') %}
                    <div class="mb-3">
                        <label class="form-label">Tamil Name</label>
                        <input type="text" class="form-control" name="tamil_name">
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_uom') %}
                    <div class="mb-3">
                        <label class="form-label">UOM</label>
                        <input type="text" class="form-control" name="uom" required>
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_price') %}
                    <div class="mb-3">
                        <label class="form-label">Price</label>
                        <input type="number" class="form-control" name="price" step="0.01" required>
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_stock') %}
                    <div class="mb-3">
                        <label class="form-label">Initial Stock</label>
                        <input type="number" class="form-control" name="stock" value="0" required>
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_restock') %}
                    <div class="mb-3">
                        <label class="form-label">Restock Level</label>
                        <input type="number" class="form-control" name="restock_level" value="0" required>
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_locations') %}
                    <div class="mb-3">
                        <label class="form-label">Stock Locations <small class="text-muted">(comma-separated)</small></label>
                        <input type="text" class="form-control" name="stock_locations" placeholder="e.g., Shelf A, Rack 1, Box 2">
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_tags') %}
                    <div class="mb-3">
                        <label class="form-label">Tags <small class="text-muted">(comma-separated)</small></label>
                        <input type="text" class="form-control" name="tags" placeholder="e.g., fragile, heavy, seasonal">
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_notes') %}
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="3" placeholder="Additional notes about the product..."></textarea>
                    </div>
                    {% endif %}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveProduct">Save Product</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <input type="hidden" name="id">
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_code') %}
                    <div class="mb-3">
                        <label class="form-label">Item Code</label>
                        <input type="text" class="form-control" name="item_code" required>
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_description') %}
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" name="description" required>
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_tamil') %}
                    <div class="mb-3">
                        <label class="form-label">Tamil Name</label>
                        <input type="text" class="form-control" name="tamil_name">
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_uom') %}
                    <div class="mb-3">
                        <label class="form-label">UOM</label>
                        <input type="text" class="form-control" name="uom" required>
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_price') %}
                    <div class="mb-3">
                        <label class="form-label">Price</label>
                        <input type="number" class="form-control" name="price" step="0.01" required>
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_stock') %}
                    <div class="mb-3">
                        <label class="form-label">Stock</label>
                        <input type="number" class="form-control" name="stock" required>
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_restock') %}
                    <div class="mb-3">
                        <label class="form-label">Restock Level</label>
                        <input type="number" class="form-control" name="restock_level" value="0" required>
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_locations') %}
                    <div class="mb-3">
                        <label class="form-label">Stock Locations <small class="text-muted">(comma-separated)</small></label>
                        <input type="text" class="form-control" name="stock_locations" placeholder="e.g., Shelf A, Rack 1, Box 2">
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_tags') %}
                    <div class="mb-3">
                        <label class="form-label">Tags <small class="text-muted">(comma-separated)</small></label>
                        <input type="text" class="form-control" name="tags" placeholder="e.g., fragile, heavy, seasonal">
                    </div>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_product_notes') %}
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="3" placeholder="Additional notes about the product..."></textarea>
                    </div>
                    {% endif %}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="updateProduct">Update Product</button>
            </div>
        </div>
    </div>
</div>

<!-- Paste Import Modal -->
<div class="modal fade" id="pasteImportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Products from Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <h6>Instructions:</h6>
                    <ol>
                        <li>Open your Excel file</li>
                        <li>Select and copy (Ctrl+C) the data rows including headers</li>
                        <li>Paste (Ctrl+V) the data below</li>
                        <li>Make sure the columns are in this order: Item Code, Description, UOM, Price, Stock</li>
                    </ol>
                </div>
                <textarea id="pasteInput" class="form-control" rows="10" placeholder="Paste your Excel data here..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="processPastedData">Import Data</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Stock Adjustment Modal -->
<div class="modal fade" id="stockAdjustmentModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adjust Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="stockAdjustmentForm">
                    <input type="hidden" id="adjustProductId">
                    <input type="hidden" id="adjustmentType">
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="adjustmentQuantity" min="1" value="1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmStockAdjustment">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stock Modal -->
<div class="modal fade" id="quickStockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickStockForm">
                    <input type="hidden" name="product_id">
                    <div class="mb-3">
                        <label class="form-label">Stock Change</label>
                        <div class="input-group">
                            <button type="button" class="btn btn-outline-secondary" onclick="adjustStock(-1)">-</button>
                            <input type="number" class="form-control text-center" name="stock_change" value="0">
                            <button type="button" class="btn btn-outline-secondary" onclick="adjustStock(1)">+</button>
                        </div>
                        <small class="form-text text-muted">Use negative numbers to decrease stock</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveStock">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Progress Modal -->
<div class="modal fade" id="importProgressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Importing Products</h5>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div id="importStatus">Processing your file...</div>
                </div>
                <div class="progress mb-3">
                    <div id="importProgressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="row text-center">
                    <div class="col">
                        <div class="h5 mb-0" id="processedCount">0</div>
                        <small class="text-muted">Processed</small>
                    </div>
                    <div class="col">
                        <div class="h5 mb-0" id="currentBatch">0</div>
                        <small class="text-muted">Current Batch</small>
                    </div>
                    <div class="col">
                        <div class="h5 mb-0" id="successCount">0</div>
                        <small class="text-muted">Imported</small>
                    </div>
                    <div class="col">
                        <div class="h5 mb-0" id="errorCount">0</div>
                        <small class="text-muted">Errors</small>
                    </div>
                </div>
                <div id="errorList" class="mt-3 d-none">
                    <h6 class="text-danger">Errors:</h6>
                    <ul id="errorDetails" class="small"></ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="closeImportModal" style="display: none;">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this product?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap components
    const editModal = new bootstrap.Modal(document.getElementById('editProductModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));

    // Edit Product Functionality
    document.querySelectorAll('.edit-product').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const form = document.getElementById('editProductForm');
            
            // Get all the data from button attributes
            const productData = {
                id: this.getAttribute('data-id'),
                item_code: this.getAttribute('data-item-code'),
                description: this.getAttribute('data-description'),
                tamil_name: this.getAttribute('data-tamil-name'),
                uom: this.getAttribute('data-uom'),
                price: this.getAttribute('data-price'),
                stock: this.getAttribute('data-stock'),
                restock_level: this.getAttribute('data-restock-level'),
                stock_locations: this.getAttribute('data-stock-locations'),
                tags: this.getAttribute('data-tags'),
                notes: this.getAttribute('data-notes')
            };

            // Populate each form field
            Object.keys(productData).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    // Ensure we don't set undefined or null values
                    const value = productData[key] || '';
                    input.value = value;
                }
            });

            // Show the modal
            editModal.show();
        });
    });

    // Handle form submission
    document.getElementById('updateProduct').addEventListener('click', function() {
        const form = document.getElementById('editProductForm');
        const id = form.querySelector('[name="id"]').value;
        
        if (!id) {
            showAlert('Error: Product ID is missing', 'danger');
            return;
        }
        
        // Create data object
        const data = {};
        const formData = new FormData(form);
        
        formData.forEach((value, key) => {
            if (value.trim() !== '') {
                // Convert numeric fields
                if (['price', 'stock', 'restock_level'].includes(key)) {
                    data[key] = key === 'price' ? parseFloat(value) : parseInt(value);
                } else {
                    data[key] = value;
                }
            }
        });

        // Send update request
        fetch(`/products/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                editModal.hide();
                showAlert('Product updated successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert(result.error || 'Failed to update product', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('An error occurred while updating the product', 'danger');
        });
    });

    // Helper function to show alerts
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        if (type === 'success') {
            setTimeout(() => {
                alertDiv.remove();
            }, 2000);
        }
    }

    // Initialize popover
    const searchHelp = document.getElementById('searchHelp');
    new bootstrap.Popover(searchHelp, {
        html: true,
        title: 'Search Tips',
        content: `
            <ul class="list-unstyled mb-0">
                <li>â€¢ Search by item code</li>
                <li>â€¢ Search by product name</li>
                <li>â€¢ Search by location</li>
                <li>â€¢ Search by tags</li>
                <li>â€¢ Search by UOM</li>
                <li>â€¢ Words can be in any order</li>
                <li>â€¢ Press Enter to search all products</li>
            </ul>
        `
    });

    let searchTimeout;
    const searchInput = document.getElementById('productSearch');
    const searchResults = document.getElementById('searchResults');
    const searchResultsGrid = document.getElementById('searchResultsGrid');
    const regularContent = document.getElementById('regularContent');

    searchInput.addEventListener('keyup', function(e) {
        const query = this.value.trim();
        
        // Clear previous timeout
        clearTimeout(searchTimeout);
        
        // If Enter is pressed, search immediately
        if (e.key === 'Enter' && query) {
            performSearch(query);
            return;
        }
        
        // For other keys, wait for user to stop typing
        if (query.length > 0) {
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        } else {
            clearSearch();
        }
    });

    function performSearch(query) {
        // Show loading state
        searchResultsGrid.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        searchResults.style.display = 'block';
        regularContent.style.display = 'none';

        fetch(`/products/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(products => {
                if (products.length > 0) {
                    displaySearchResults(products);
                } else {
                    searchResultsGrid.innerHTML = '<div class="text-center text-muted">No products found</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                searchResultsGrid.innerHTML = '<div class="text-center text-danger">Error searching products</div>';
            });
    }

    function displaySearchResults(products) {
        searchResultsGrid.innerHTML = products.map(product => `
            <div class="product-card" data-id="${product.id}">
                <div class="card-row">
                    <span class="label">Item Code</span>
                    <span class="value">${product.item_code}</span>
                </div>
                <div class="card-row">
                    <span class="label">Description</span>
                    <span class="value">${product.description}</span>
                </div>
                ${product.tamil_name ? `
                <div class="card-row">
                    <span class="label">Tamil Name</span>
                    <span class="value">${product.tamil_name}</span>
                </div>
                ` : ''}
                <div class="card-row">
                    <span class="label">UOM</span>
                    <span class="value">${product.uom}</span>
                </div>
                <div class="card-row">
                    <span class="label">Price</span>
                    <span class="value">â‚¹${product.price}</span>
                </div>
                <div class="card-row">
                    <span class="label">Stock</span>
                    <span class="value">${product.stock}</span>
                </div>
                ${product.stock_locations ? `
                <div class="card-row">
                    <span class="label">Locations</span>
                    <span class="value">
                        ${product.stock_locations.split(',').map(loc => 
                            `<span class="badge bg-info me-1">${loc.trim()}</span>`
                        ).join('')}
                    </span>
                </div>
                ` : ''}
                ${product.tags ? `
                <div class="card-row">
                    <span class="label">Tags</span>
                    <span class="value">
                        ${product.tags.split(',').map(tag => 
                            `<span class="badge bg-secondary me-1">${tag.trim()}</span>`
                        ).join('')}
                    </span>
                </div>
                ` : ''}
                <div class="actions">
                    {% if current_user.role == 'admin' or current_user.has_permission('edit_products') %}
                    <button class="btn btn-primary edit-product" 
                            data-id="${product.id}"
                            data-code="${product.item_code}"
                            data-description="${product.description}"
                            data-tamil-name="${product.tamil_name || ''}"
                            data-uom="${product.uom}"
                            data-price="${product.price}"
                            data-stock="${product.stock}"
                            data-restock-level="${product.restock_level || 0}"
                            data-stock-locations="${product.stock_locations || ''}"
                            data-tags="${product.tags || ''}"
                            data-notes="${product.notes || ''}">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    {% endif %}
                    
                    {% if current_user.role == 'admin' or current_user.has_permission('delete_products') %}
                    <button class="btn btn-danger delete-product" data-id="${product.id}">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    {% endif %}
                </div>
            </div>
        `).join('');

        searchResults.style.display = 'block';
        regularContent.style.display = 'none';
    }

    function clearSearch() {
        searchInput.value = '';
        searchResults.style.display = 'none';
        regularContent.style.display = 'block';
    }

    // Import button click handler
    const importButton = document.getElementById('importButton');
    const importFile = document.getElementById('importFile');
    if (importButton) {
        importButton.addEventListener('click', function() {
            importFile.click();
        });
    }
    
    // File Import Handler
    const importProgressModal = new bootstrap.Modal(document.getElementById('importProgressModal'));
    const importStatus = document.getElementById('importStatus');
    const importProgressBar = document.getElementById('importProgressBar');
    const processedCount = document.getElementById('processedCount');
    const currentBatch = document.getElementById('currentBatch');
    const successCount = document.getElementById('successCount');
    const errorCount = document.getElementById('errorCount');
    const errorList = document.getElementById('errorList');
    const errorDetails = document.getElementById('errorDetails');
    const closeImportModal = document.getElementById('closeImportModal');

    window.handleImport = function(input) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];
        const formData = new FormData();
        formData.append('file', file);

        // Reset and show progress modal
        processedCount.textContent = '0';
        currentBatch.textContent = '0';
        successCount.textContent = '0';
        errorCount.textContent = '0';
        importProgressBar.style.width = '0%';
        errorList.classList.add('d-none');
        errorDetails.innerHTML = '';
        importStatus.textContent = 'Processing your file...';
        closeImportModal.style.display = 'none';
        importProgressModal.show();

        fetch('/products/import', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update batch progress
                const totalBatches = data.total_batches;
                let currentBatchNum = 0;
                
                // Function to simulate batch processing with delays
                function updateBatchProgress() {
                    if (currentBatchNum < totalBatches) {
                        currentBatchNum++;
                        const progress = (currentBatchNum / totalBatches) * 100;
                        
                        // Update UI
                        importProgressBar.style.width = `${progress}%`;
                        currentBatch.textContent = `${currentBatchNum}/${totalBatches}`;
                        importStatus.innerHTML = `<i class="fas fa-sync fa-spin"></i> Processing batch ${currentBatchNum} of ${totalBatches}...`;
                        
                        // Add delay between batches (1 second)
                        setTimeout(updateBatchProgress, 1000);
                    } else {
                        // Final update
                        importStatus.innerHTML = '<i class="fas fa-check-circle text-success"></i> Import completed';
                        importProgressBar.style.width = '100%';
                        processedCount.textContent = data.total_count;
                        successCount.textContent = data.imported_count;
                        errorCount.textContent = data.error_count;
                        
                        // Show any errors if present
                        if (data.error_count > 0) {
                            errorList.classList.remove('d-none');
                            data.error_details.forEach(error => {
                                const li = document.createElement('li');
                                li.textContent = error;
                                errorDetails.appendChild(li);
                            });
                        }
                        
                        // Reload page after completion
                        setTimeout(() => location.reload(), 2000);
                    }
                }
                
                // Start batch progress simulation
                updateBatchProgress();
            } else {
                importStatus.innerHTML = '<i class="fas fa-times-circle text-danger"></i> Import failed';
                errorList.classList.remove('d-none');
                
                if (data.error_details && data.error_details.length > 0) {
                    data.error_details.forEach(error => {
                        const li = document.createElement('li');
                        li.textContent = error;
                        errorDetails.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.textContent = data.error || 'Unknown error occurred';
                    errorDetails.appendChild(li);
                }
                
                importProgressBar.style.width = '100%';
                closeImportModal.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            importStatus.innerHTML = '<i class="fas fa-times-circle text-danger"></i> Import failed';
            errorList.classList.remove('d-none');
            const li = document.createElement('li');
            li.textContent = 'Network error occurred. Please try again.';
            errorDetails.appendChild(li);
            closeImportModal.style.display = 'block';
        })
        .finally(() => {
            input.value = '';
        });
    };

    // Add Product
    document.getElementById('saveProduct').addEventListener('click', function() {
        const form = document.getElementById('addProductForm');
        const formData = new FormData(form);
        
        // Create data object with only non-empty values
        const data = {};
        formData.forEach((value, key) => {
            if (value.trim() !== '') {
                // Convert numeric fields
                if (['price', 'stock', 'restock_level'].includes(key)) {
                    data[key] = key === 'price' ? parseFloat(value) : parseInt(value);
                } else {
                    data[key] = value;
                }
            }
        });

        // Validate required fields
        if (!data.item_code || !data.description || !data.uom || !data.price) {
            showAlert('Please fill in all required fields', 'danger');
            return;
        }

        fetch('/products', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
                showAlert('Product added successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert(data.error || 'Failed to add product', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('An error occurred while adding the product', 'danger');
        });
    });

    // Delete product functionality
    let productToDelete = null;
    
    // Handle delete button clicks
    document.querySelectorAll('.delete-product').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            productToDelete = this.dataset.id;
            deleteModal.show();
        });
    });
    
    // Handle delete confirmation
    document.getElementById('confirmDelete').addEventListener('click', async function() {
        if (!productToDelete) return;
        
        try {
            // Disable the delete button
            const deleteBtn = document.getElementById('confirmDelete');
            deleteBtn.disabled = true;
            
            const response = await fetch(`/products/${productToDelete}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Close all modals
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) {
                        bsModal.hide();
                    }
                });
                
                // Remove any existing alerts
                const alerts = document.querySelectorAll('.alert');
                alerts.forEach(alert => alert.remove());
                
                // Redirect without showing any messages
                window.location.href = '/products';
            }
        } catch (error) {
            // Just close the modal and reset state without showing errors
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            });
        } finally {
            productToDelete = null;
            document.getElementById('confirmDelete').disabled = false;
        }
    });

    // Quick Stock Adjustment
    const stockModal = new bootstrap.Modal(document.getElementById('stockAdjustmentModal'));

    document.querySelectorAll('.quick-stock-dec, .quick-stock-inc').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.dataset.id;
            const isDecrease = this.classList.contains('quick-stock-dec');
            
            // Set values in the modal
            document.getElementById('adjustProductId').value = id;
            document.getElementById('adjustmentType').value = isDecrease ? 'decrease' : 'increase';
            document.getElementById('adjustmentQuantity').value = '1';
            
            // Update modal title based on action
            document.querySelector('#stockAdjustmentModal .modal-title').textContent = 
                isDecrease ? 'Decrease Stock' : 'Increase Stock';
            
            // Show the modal
            stockModal.show();
        });
    });

    // Update stock adjustment confirmation
    document.getElementById('confirmStockAdjustment').addEventListener('click', function() {
        const id = document.getElementById('adjustProductId').value;
        const type = document.getElementById('adjustmentType').value;
        const quantity = parseInt(document.getElementById('adjustmentQuantity').value) || 0;
        
        if (quantity <= 0) {
            alert('Please enter a valid quantity');
            return;
        }
        
        const change = type === 'decrease' ? -quantity : quantity;
        
        fetch(`/products/${id}/stock`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ change: change })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Find the product card and update only the stock value
                const productCard = document.querySelector(`.product-card[data-id="${id}"]`);
                const stockRow = Array.from(productCard.querySelectorAll('.card-row')).find(row => 
                    row.querySelector('.label').textContent.trim() === 'Stock'
                );
                if (stockRow) {
                    stockRow.querySelector('.value').textContent = data.new_stock;
                }
                
                // Close the modal
                bootstrap.Modal.getInstance(document.getElementById('stockAdjustmentModal')).hide();
            } else {
                alert('Error updating stock: ' + data.error);
            }
        });
    });

    // Quick Stock functionality
    const quickStockModal = new bootstrap.Modal(document.getElementById('quickStockModal'));
    
    document.querySelectorAll('.quick-stock').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.id;
            const form = document.getElementById('quickStockForm');
            form.querySelector('[name="product_id"]').value = productId;
            form.querySelector('[name="stock_change"]').value = 0;
            quickStockModal.show();
        });
    });
    
    function adjustStock(amount) {
        const input = document.querySelector('#quickStockForm [name="stock_change"]');
        input.value = parseInt(input.value || 0) + amount;
    }
    
    document.getElementById('saveStock').addEventListener('click', function() {
        const form = document.getElementById('quickStockForm');
        const productId = form.querySelector('[name="product_id"]').value;
        const change = parseInt(form.querySelector('[name="stock_change"]').value || 0);
        
        fetch(`/products/${productId}/stock`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ change: change })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating stock: ' + data.error);
            }
        });
    });
});
</script>
{% endblock %} 